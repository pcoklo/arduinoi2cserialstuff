#include <Wire.h>
#include <RCSwitch.h>

RCSwitch mySwitch = RCSwitch();

String inputString="", dataString="", tempString="", nullString="";

int Address=9, Quantity=10, operation=1;

const int wire=1, rc=2;

void setup(){
  mySwitch.enableTransmit(4);
  Wire.begin();
  Serial.begin(115200);
  delay(100);
  pinMode(A4, INPUT_PULLUP);
  pinMode(A5, INPUT_PULLUP);
}

void loop(){}

void serialEvent() {
  inputString=nullString;while(Serial.available()>0){inputString+=(char)Serial.read();delayMicroseconds(100); }

  if(inputString.startsWith("wire"))operation=wire;
  if(inputString.startsWith("rc"))operation=rc;

  dataString=inputString.substring(inputString.lastIndexOf(" ")+1,inputString.length());

  if(inputString.indexOf("-")>=0){ //ako je jedna opcija zadana
    if(inputString.charAt(inputString.indexOf("-")+1)=='a'){
      tempString=inputString.substring(inputString.indexOf("a")+1,inputString.indexOf(" ",inputString.indexOf("a")+2));
      if(tempString.toInt()>0)Address=tempString.toInt();
    }  
    if(inputString.charAt(inputString.indexOf("-")+1)=='q'){
      tempString = inputString.substring(inputString.indexOf("q")+1,inputString.indexOf(" ",inputString.indexOf("q")+2));
      if(tempString.toInt()>0)Quantity=tempString.toInt();
    }
  }

  if(inputString.indexOf("-",inputString.indexOf("-")+1)>=0){// ako je druga pocija zadana
    if(inputString.charAt(inputString.indexOf("-",inputString.indexOf("-")+1)+1)=='a'){
      tempString = inputString.substring(inputString.indexOf("a")+1,inputString.indexOf(" ",inputString.indexOf("a")+2));
      if(tempString.toInt()>0)Address=tempString.toInt();
    }
    if(inputString.charAt(inputString.indexOf("-",inputString.indexOf("-")+1)+1)=='q'){
      tempString=inputString.substring(inputString.indexOf("q")+1,inputString.indexOf(" ",inputString.indexOf("q")+2));
      if(tempString.toInt()>0)Quantity=tempString.toInt();
    }
  }

  inputString=nullString;

  if(operation==wire){
    if(Address>0&&Address<100){
      byte data[dataString.length()];for(byte i=0;i<dataString.length();i++)data[i]=dataString.charAt(i);
      if(dataString=="wire"){
        Serial.print("Getting all addressies: ");
        for(int i=1; i<100; i++){
          Wire.beginTransmission(i);Wire.write(data,dataString.length());Wire.endTransmission();delay(10);
          Wire.requestFrom(i,Quantity,true);while(Wire.available()){byte c=Wire.read();if(c!=255)inputString+=(char)c;}
          if(inputString=="no") {Serial.print(i); Serial.print(" ");} inputString=nullString; 
        }Serial.println();Serial.println("Done\n");
      }
      else{
        Wire.beginTransmission(Address);Wire.write(data,dataString.length());Wire.endTransmission();delay(100);
        Wire.requestFrom(Address,Quantity,true);while(Wire.available()){byte c=Wire.read();if(c!=255)inputString+=(char)c;}
        Serial.print("Wire sent: ");Serial.println(dataString);
        Serial.print("Device: ");Serial.println(Address);
        Serial.print("Bytes to receive: ");Serial.println(Quantity);
        if(inputString=="yes")Serial.println("Transmission succeed");
        else if(inputString=="no")Serial.println("Transmission incorrect");
        else if(inputString==nullString)Serial.println("Transmission falied");
        else Serial.println(inputString);
        Serial.println();
      }
    }
    else{Serial.print("Address ");Serial.print(Address);Serial.println(" is invalid\nPlease select right address\n");}
  }
  else if(operation==rc){
    Serial.print("RC sent: ");Serial.println(dataString);
    if(dataString=="A")mySwitch.send("010101010100010101010001");
    else if(dataString=="a")mySwitch.send("010101010100010101010100");
    else if(dataString=="B")mySwitch.send("010101010101000101010001");
    else if(dataString=="b")mySwitch.send("010101010101000101010100");
    else if(dataString=="C")mySwitch.send("010101010101010001010001");
    else if(dataString=="c")mySwitch.send("010101010101010001010100");
    else if(dataString=="D")mySwitch.send("010101010101010100010001");
    else if(dataString=="d")mySwitch.send("010101010101010100010100");
    else if(dataString=="E")mySwitch.send("000101010100010101010001");
    else if(dataString=="e")mySwitch.send("000101010100010101010100");
    else Serial.println("Wrong comand");
  }
  else Serial.println("Unknown operation");
}
